<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>My Journal Entries</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <!-- navbar -->
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <a href="/entries" class="navbar-brand">My Journal</a>
            <form th:action="@{/logout}" method="post">
                <button type="submit" class="btn btn-outline-light btn-sm">Logout</button>
            </form>

        </div>
    </nav>

    <!-- main content -->
     <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>My Entries</h2>
            <a href="/entries/new" class="btn btn-success">+ new entry</a>
        </div>


        <!-- Loading message -->
        <div id="loading" class="alert alert-info">Loading entries...</div>

        <!-- empty state -->
        <div id="emptyState" class="alert alert-info" style="display: none;">
            No entries found. Click "+ new entry" to create your first journal entry.
        </div>

        <div id="entriesList"></div>
     </div>

     <script>

         function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return 'Invalid Date';
                }
                return date.toLocaleDateString('en-IN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            } catch (error) {
                return 'Invalid Date';
            }
        }
        // fetch and load entries
        async function loadEntries() {
            try{
                const response = await fetch('/journal', {
                    method: 'GET',
                    credentials: 'same-origin'
                });



                const loading = document.getElementById('loading');
                const emptyState = document.getElementById('emptyState');  
                const entriesList = document.getElementById('entriesList');

                if(response.ok){
                    const entries = await response.json();
                    console.log('Entries:', entries);
                    console.log('First entry:', entries[0]);
                    console.log('First entry ID:', entries[0]?.id);
                    console.log(response);
                    loading.style.display = 'none';

                    if(entries.length === 0){
                        emptyState.style.display = 'block';
                    }else{

                        
                        entriesList.innerHTML = entries.map(entry => {
                            const entryId = entry.id;
                            return`
                            <div class="card mb-3 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title">${entry.title || 'Untitled'}</h5>
                                        <p class="card-text">${entry.content}</p>
                                        <small class="text-muted">
                                            Created: ${entry.date ? formatDate(entry.date) : 'N/A'}
                                        </small>
                                        <div class="mt-3">
                                            <a href="/entries/edit/${entryId}" class="btn btn-sm btn-primary">Edit</a>
                                            <button onclick="deleteEntry('${entryId}')" class="btn btn-sm btn-danger">Delete</button>
                                        </div>
                                    </div>
                                </div>
                            `
                            
                        }).join(''); 
                    }
                }else if(response.status === 404){
                    loading.style.display = 'none';
                    emptyState.style.display = 'block';
                }else {
                    loading.innerHTML = 'Error loading entries.';
                }
            }catch(error){
                console.error('Error fetching entries:', error);
                document.getElementById('loading').innerText = 'Error loading entries.';
            }

        }

        async function deleteEntry(id){
            if(!confirm('Are you sure you want to delete this entry?')){
                return;
            }

            try{
                const response = await fetch(`/journal/${id}`, {
                    method: 'DELETE',
                    credentials: 'same-origin'
                });

                console.log(response);

                if(response.ok || response.status === 204){
                    // alert ('Entry deleted successfully.');
                    location.reload();
                }else{
                    alert('Error deleting entry.');
                }
            }catch(error){
                console.error('Error deleting entry:', error);
                alert('Error deleting entry.');
            }
        }

        // load entries on page load
        window.onload = loadEntries;
     </script>

</body>
</html>